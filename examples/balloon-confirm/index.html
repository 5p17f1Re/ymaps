<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Примеры. Создание метки с диалогом подтверждения.</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <link href="/bootstrap/css/bootstrap.css" rel="stylesheet">

    <script src="//yandex.st/jquery/1.8.0/jquery.min.js" type="text/javascript"></script>
    <script src="//api-maps.yandex.ru/2.0/?load=package.full&lang=ru-RU" type="text/javascript"></script>

    <script type="text/javascript">
    ymaps.ready(function () {
        var myPlacemark,
            myMap = new ymaps.Map('YMapsID', {
                center: [55.751574, 37.573856],
                zoom: 9,
                behaviors: ['scrollZoom', 'drag']
            }),
            /**
             * @see http://api.yandex.ru/maps/doc/jsapi/2.x/ref/reference/templateLayoutFactory.xml
             */
            MyBalloonLayout = ymaps.templateLayoutFactory.createClass(
                '<div class="popover top">' +
                    '<a class="close" href="#">&times;</a>' +
                    '<div class="arrow"></div>' +
                    '<div class="popover-inner">' +
                        '<div class="row-fluid span8">' +
                            '<div class="row-fluid">' +
                                '<p class="lead">Создание объекта</p>' +
                            '</div>' +
                            '<div class="row-fluid">' +
                                '<button type="reset" class="btn btn-warning">Отменить</button>' +
                                '<button type="submit" class="btn btn-success">Создать</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>', {
                build: function () {
                    MyBalloonLayout.superclass.build.call(this);

                    this.$element = $(this.getParentElement()).find('.popover');
                    this.setElementOffset();

                    $('[type=submit]').on('click', $.proxy(this.onCreateClick, this));
                    this.$element
                        .find('.close,[type=reset]')
                        .on('click', $.proxy(this.onCloseClick, this));
                },
                clear: function () {
                    this.$element
                        .find('[type=submit],[type=reset],.close')
                        .off('click');
                    MyBalloonLayout.superclass.clear.call(this);
                },
                /**
                 * Сдвигаем балун чтобы "хвостик" указывал на точку привязки.
                 * @see http://api.yandex.ru/maps/doc/jsapi/2.x/ref/reference/IBalloonLayout.xml#event-userclose
                 * @function
                 * @name setElementOffset
                 */
                setElementOffset: function () {
                    this.$element.css({
                        left: -(this.$element[0].offsetWidth / 2),
                        top: -(this.$element[0].offsetHeight + this.$element.find('.arrow')[0].offsetHeight)
                    });
                },
                onCreateClick: function (e) {
                    e.preventDefault();

                    var data = this.getData(),
                        balloon = data.balloon,
                        coords = balloon.getPosition();

                    if(myPlacemark) {
                        myPlacemark.geometry.setCoordinates(coords);
                    }
                    else {
                        myPlacemark = new ymaps.Placemark(coords, {}, { preset: 'twirl#blueIcon' });
                        myMap.geoObjects.add(myPlacemark);
                    }

                    this._processData(coords);
                    this.closeBalloon();
                },
                onCloseClick: function (e) {
                    e.preventDefault();

                    this.closeBalloon();
                },
                /**
                 * Закрывает балун.
                 * @function
                 * @name closeBalloon
                 */
                closeBalloon: function () {
                    this.getData().balloon.close();
                },
                _processData: function (coords) {
                    // Тут что-то делаем с кординатами, например отправляем на сервер.
                    console.log(coords);
                }
            }),
            /**
             * @see http://api.yandex.ru/maps/doc/jsapi/2.x/ref/reference/Balloon.xml
             */
            myBalloon = new ymaps.Balloon(myMap);

        myBalloon.options
            .set({ layout: MyBalloonLayout })
            .setParent(myMap.options);

        myMap.events.add('click', function (e) {
            var coords = e.get('coordPosition');

            if(myBalloon.isOpen()) {
                myBalloon.close();
            }
            else {
                myBalloon
                    .setData({
                        balloon: myBalloon
                    })
                    .open(coords);
            }
        });
    });
    </script>
    <style type="text/css">
        #YMapsID {
            width: 900px;
            height: 400px;
        }
        .popover {
            display: block;
            width: 260px;
            height: 100px;
            padding: 10px;
        }
        .popover .close {
            position: absolute;
            right: 5px;
            top: 1px;
        }
        .btn-success {
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="hero-unit">
        <div class="container">
            <p>Создание метки с диалогом подтверждения.</p>
            <div id="YMapsID"></div>
        </div>
    </div>
</body>
</html>
