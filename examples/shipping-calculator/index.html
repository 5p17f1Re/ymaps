<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Пример: Расчет стоимости доставки.</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<script src="http://api-maps.yandex.ru/2.0/?load=package.full&lang=ru-RU&mode=debug" type="text/javascript"></script>
<script src="https://raw.github.com/dimik/ymaps/master/multi-geocoder.js" type="text/javascript"></script>
<script src="https://raw.github.com/dimik/ymaps/master/directions-renderer.js" type="text/javascript"></script>
<script src="https://raw.github.com/dimik/ymaps/master/directions-service.js" type="text/javascript"></script>

<script type="text/javascript">
function init() {
    var myMap = window.map = new ymaps.Map('map', {
            center: [55.7, 37.5],
            zoom: 9,
            type: 'yandex#map',
            behaviors: ['scrollZoom', 'drag']
        }),
        search = new ymaps.control.SearchControl({
            useMapBounds: true,
            noCentering: true,
            noPlacemark: true
        });

    var tarifs = [{
            name: "Москва",
            area: {
                type: "Polygon",
                url: "http://maps.yandex.ru/export/usermaps/Ik1vpVgikUAKRVdtokML99zzhBLlN7BK/",
                has: function (step) {
                    return this.geometry.contains(step.end_location) && !step.street.match(/МКАД/ig);
                }
            },
            cost: 20
        }, {
            name: "Московская область",
            area: {
                type: "Polygon",
                url: "http://maps.yandex.ru/export/usermaps/K7PmDPE5MeWZw-O-x6zhZ1zboyf5YDR6/",
                has: function (step) {
                    return this.geometry.contains(step.end_location) || step.street.match(/МКАД/ig);
                }
            },
            cost: 40
        }];

    var calculator = new ShippingCalculator(myMap, myMap.getCenter(), tarifs);

    myMap.controls.add(search, { right: 5, top: 5 });

    calculator.ready(function () {
        search.events.add('resultselect', function (e) {
            var results = search.getResultsArray(),
                selected = e.get('resultIndex'),
                point = results[selected].geometry.getCoordinates();

                calculator.setDestination(point);
        });
    });
}

function ShippingCalculator(map, origin, tarifs) {
    this._map = map;
    this._routeService = new DirectionsService({ avoidTrafficJams: true });
    this._routeRenderer = new DirectionsRenderer({ draggable: true, map: map });
    this._origin = origin;
    this._tarifs = tarifs;
}

ShippingCalculator.prototype = {
    constructor: ShippingCalculator,
    ready: function (cb) {
        var map = this._map,
            tarifs = this._tarifs,
            count = tarifs.length;

        tarifs.forEach(function (tarif) {
            ymaps.geoXml.load(tarif.area.url)
                .then(function (res) {
                    var geometry = res.geoObjects.get(0).geometry;

                    geometry.setMap(map);
                    geometry.options.setParent(map.options);
                    tarif.area.geometry = geometry;
                    if(--count == 0) {
                        cb();
                    }
                });
        });
    },
    _onDestinationChange: function (e) {
        this.setDestination(e.get('coordPosition'));
    },
    getDirections: function (request) {
        var self = this;

        this._routeService.route(request, function (result) {
            self._routeRenderer.setDirections(result);
            self.calculate(result.routes[0]);
        });
    },
    setDestination: function (position) {
        this._routeRenderer.events.add('waypointschange', function (e) {
            this.getDirections({
                origin: e.get('origin'),
                destination: e.get('destination')
            });
        }, this);

        this.getDirections({
            origin: this._origin,
            destination: position // this._destination.geometry.getCoordinates()
        });
    },
    calculate: function (route) {
        // Константы.
        var coordSystem = this._map.options.get('projection').getCoordSystem(),
            MINIMUM_COST = 300,
            tarifs = this._tarifs,
            tarif, i = 0,
            results = tarifs.map(function (tarif) {
                return {
                    name: tarif.name,
                    distance: 0,
                    cost: 0
                };
            });

        route.legs.forEach(function (leg) {
            leg.steps.forEach(function (step) {
                while(tarif = tarifs[i]) {
                    var distance = 0;

                    console.log(tarif.area.has(step), !tarif.area.geometry.contains(step.start_location), tarif.name, step.street);
                    if(tarif.area.has(step)) {
                        distance = step.distance;
                    }
                    else if(!tarif.area.geometry.contains(step.start_location)) {
                        distance = step.path.reduce(function (distance, point, index, path) {
                            return tarif.area.geometry.contains(point) ?
                                distance + coordSystem.getDistance(path[index - 1] || point, point) :
                                distance;
                        }, distance);

                        if(results[i - 1]) {
                            console.log('diff', step.distance - distance);
                            results[i - 1].distance += (step.distance - distance) / 1000;
                        }
                    }
                    results[i].distance += (distance /= 1000);
                    results[i].cost += distance * tarif.cost;
                    break;

                    i += 1;
                }
            });
        });

        console.log(results);
        // return Math.max(len * DELIVERY_TARIF, MINIMUM_COST);
    }
};

ymaps.ready(init);

</script>
<style>
html, body, #map {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
}
</style>
</head>

<body>
    <div id="map"></div>
</body>

</html>
