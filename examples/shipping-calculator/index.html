<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Пример: Расчет стоимости доставки.</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<script src="http://api-maps.yandex.ru/2.0/?load=package.full&lang=ru-RU&mode=debug" type="text/javascript"></script>
<script src="https://raw.github.com/dimik/ymaps/master/multi-geocoder.js" type="text/javascript"></script>
<script src="directions-renderer.js" type="text/javascript"></script>
<script src="directions-service.js" type="text/javascript"></script>
<script src="tarifs.js" type="text/javascript"></script>

<script type="text/javascript">
function init() {
    var myMap = window.map = new ymaps.Map('map', {
            center: [55.7, 37.5],
            zoom: 9,
            type: 'yandex#map',
            behaviors: ['scrollZoom', 'drag']
        }),
        search = new ymaps.control.SearchControl({
            useMapBounds: true,
            noCentering: true,
            noPlacemark: true
        });


    var calculator = new ShippingCalculator(myMap, myMap.getCenter(), tarifs);

    myMap.controls.add(search, { right: 5, top: 5 });

    search.events.add('resultselect', function (e) {
        var results = search.getResultsArray(),
            selected = e.get('resultIndex'),
            point = results[selected].geometry.getCoordinates();

            calculator.setDestination(point);
    });
}

function ShippingCalculator(map, origin, tarifs) {
    this._map = map;
    this._routeService = new DirectionsService({ avoidTrafficJams: true });
    this._routeRenderer = new DirectionsRenderer({ draggable: true, map: map });
    this._origin = origin;
    this._tarifs = tarifs;

    tarifs.forEach(function (tarif) {
        var geometry = new ymaps.geometry.Polygon(tarif.coordinates);

        geometry.setMap(map);
        geometry.options.setParent(map.options);

        tarif.geometry = geometry;
    });
}

ShippingCalculator.prototype = {
    constructor: ShippingCalculator,
    _onDestinationChange: function (e) {
        this.setDestination(e.get('coordPosition'));
    },
    getDirections: function (request) {
        var self = this;

        this._routeService.route(request, function (result) {
            // self._routeRenderer.setDirections(result);
            self.calculate(result.routes[0]);
        });
    },
    setDestination: function (position) {
        this._routeRenderer.events.add('waypointschange', function (e) {
            this.getDirections({
                origin: e.get('origin'),
                destination: e.get('destination')
            });
        }, this);

        this.getDirections({
            origin: this._origin,
            destination: position
        });
    },
    _getDistance: function (tarif, step) {
        var geometry = tarif.geometry;
            coordSystem = this._map.options.get('projection').getCoordSystem();

        console.log(tarif.name, step.street, tarif.test(step), geometry.contains(step.start_location), geometry.contains(step.end_location));

        if(tarif.test(step)) {
            this._map.geoObjects.add(new ymaps.Polyline(step.path, {}, {
                strokeColor: tarif.name == 'Москва' && '#ff0000' || '#00ff00',
                strokeWidth: 2
            }));
            return step.distance;
        }
        else if(geometry.contains(step.start_location) || geometry.contains(step.end_location)) {
            var self = this;

            return step.distance - step.path.reduce(function (distance, point, index, path) {
                if(tarif.geometry.contains(point)) {
                    self._map.geoObjects.add(new ymaps.Polyline([path[index - 1] || point, point], {}, {
                        strokeColor: tarif.name == 'Москва' && '#ff0000' || '#00ff00',
                        strokeWidth: 2
                    }));
                }
                return tarif.geometry.contains(point) ?
                    distance + coordSystem.getDistance(path[index - 1] || point, point) :
                    distance;
            }, 0);
        }

        return 0;
    },
    getRoutesByTarifs: function (result) {
        var tarifs = this._tarifs,
            routes = [],
            legs = [];

        tarifs.forEach(function (tarif) {
            var route = { distance: 0, bounds: null },
                leg = { steps: [] };

            result.routes[0].legs[0].steps.forEach(function (step) {
                if(tarif.test(step)) {
                    leg.steps.push(step);
                }
                else {
                    var path = [];

                    step.path.forEach(function (point) {
                        if(tarif.geometry.contains(point)) {
                            path.push(point);
                        }
                    });
                }
            }, this);

            this._map.geoObjects.add(new ymaps.Polyline(points, {}, { strokeColor: tarif.color }));
        }, this);

        console.log(results);
        // return Math.max(len * DELIVERY_TARIF, MINIMUM_COST);
    },
    calculate: function (route) {
        // Константы.
            MINIMUM_COST = 300,
            tarifs = this._tarifs,
            leg = legs[0],
            results = tarifs.map(function (tarif) {
                return {
                    name: tarif.name,
                    distance: 0,
                    cost: 0
                };
            });

        console.log(route);

        tarifs.forEach(function (tarif) {
            var points = [];

            leg.steps.forEach(function (step) {
                if(tarif.test(step)) {
                    points = points.concat(step.path);
                }
                else {
                    step.path.forEach(function (point) {
                        if(tarif.geometry.contains(point)) {
                            points.push(point);
                        }
                    });
                }
            }, this);

            this._map.geoObjects.add(new ymaps.Polyline(points, {}, { strokeColor: tarif.color }));
        }, this);

        console.log(results);
        // return Math.max(len * DELIVERY_TARIF, MINIMUM_COST);
    }
};

ymaps.ready(init);

</script>
<style>
html, body, #map {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
}
</style>
</head>

<body>
    <div id="map"></div>
</body>

</html>
